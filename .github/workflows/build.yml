name: Build GodotAI

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  GODOT_VERSION: "4.4"

jobs:
  build:
    name: Build ${{ matrix.platform }} (${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows
          - platform: windows
            os: windows-latest
            arch: x86_64
            
          # Linux
          - platform: linux
            os: ubuntu-latest
            arch: x86_64
          
          # macOS Universal (Intel + Apple Silicon)
          - platform: macos
            os: macos-latest
            arch: universal

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.22.x'
      
      - name: Set up MSVC (Windows)
        if: matrix.platform == 'windows'
        uses: ilammy/msvc-dev-cmd@v1
      
      - name: Install dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libssl-dev
      
      - name: Install dependencies (macOS)
        if: matrix.platform == 'macos'
        run: |
          brew install cmake

      - name: Build GodotAI
        env:
          CI: true
          GODOTAI_NON_INTERACTIVE: "1"
          GODOT_VERSION: ${{ env.GODOT_VERSION }}
          BUILD_ARCH: ${{ matrix.arch }}
        run: |
          if [ "$RUNNER_OS" = "Windows" ]; then
            # use bash on Windows (Git for Windows) — export for the python call
            export PYTHONUTF8=1
            python -c "
            import os
            import sys
            
            # Import and execute tool directly
            try:
                from tools import get_tool_by_name
                
                tool = get_tool_by_name('ci-build', include_hidden=True)
                
                args = {
                    'godot_version': os.environ['GODOT_VERSION'],
                    'arch': os.environ['BUILD_ARCH'],
                    'target': 'editor',
                    'build_type': 'Release',
                    'precision': 'single',
                    'verbose': False
                }
                
                result = tool.execute(args)
                sys.exit(result)
            except Exception as e:
                print(f'Error: {e}', file=sys.stderr)
                import traceback
                traceback.print_exc()
                sys.exit(1)
            "
          else
            python -c "
            import os
            import sys
            
            # Import and execute tool directly
            try:
                from tools import get_tool_by_name
                
                tool = get_tool_by_name('ci-build', include_hidden=True)
                
                args = {
                    'godot_version': os.environ['GODOT_VERSION'],
                    'arch': os.environ['BUILD_ARCH'],
                    'target': 'editor',
                    'build_type': 'Release',
                    'precision': 'single',
                    'verbose': False
                }
                
                result = tool.execute(args)
                sys.exit(result)
            except Exception as e:
                print(f'Error: {e}', file=sys.stderr)
                import traceback
                traceback.print_exc()
                sys.exit(1)
            "
          fi
        shell: bash

      - name: Build GodotAI
        env:
          CI: true
          GODOTAI_NON_INTERACTIVE: "1"
          GODOT_VERSION: ${{ env.GODOT_VERSION }}
          BUILD_ARCH: ${{ matrix.arch }}
        run: |
          python -c 
      
      - name: Verify build output
        shell: bash
        run: |
          echo "Checking for build artifacts..."
          if [ -d "plugin/bin/${{ matrix.platform }}" ]; then
            echo "✅ Build artifacts found:"
            ls -la plugin/bin/${{ matrix.platform }}/
          else
            echo "❌ Build artifacts not found in plugin/bin/${{ matrix.platform }}"
            echo "Contents of plugin/bin/:"
            ls -la plugin/bin/ || echo "plugin/bin/ does not exist"
            exit 1
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gdai-${{ matrix.platform }}-${{ matrix.arch }}
          path: plugin/bin/${{ matrix.platform }}/
          retention-days: 7
          if-no-files-found: error
  
  package:
    name: Package Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: Verify downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -laR artifacts/
      
      - name: Organize plugin structure
        run: |
          mkdir -p release/addons/gdai/bin
          
          echo "Copying platform binaries..."
          
          # Copy Windows binaries
          if [ -d "artifacts/gdai-windows-x86_64" ]; then
            mkdir -p release/addons/gdai/bin/windows
            cp -r artifacts/gdai-windows-x86_64/* release/addons/gdai/bin/windows/
            echo "✅ Windows binaries copied"
          fi
          
          # Copy Linux binaries
          if [ -d "artifacts/gdai-linux-x86_64" ]; then
            mkdir -p release/addons/gdai/bin/linux
            cp -r artifacts/gdai-linux-x86_64/* release/addons/gdai/bin/linux/
            echo "✅ Linux binaries copied"
          fi
          
          # Copy macOS binaries
          if [ -d "artifacts/gdai-macos-universal" ]; then
            mkdir -p release/addons/gdai/bin/macos
            cp -r artifacts/gdai-macos-universal/* release/addons/gdai/bin/macos/
            echo "✅ macOS binaries copied"
          fi
          
          echo "Binary structure:"
          ls -laR release/addons/gdai/bin/
      
      - name: Generate multi-platform gdextension file
        run: |
          cat > release/addons/gdai/gdai.gdextension << 'EOF'
          [configuration]
          entry_symbol = "gdai_library_init"
          compatibility_minimum = "4.4"
          reloadable = true
          
          [libraries]
          # Windows
          windows.editor.x86_64 = "res://addons/gdai/bin/windows/libgdai.windows.editor.x86_64.dll"
          
          # Linux
          linux.editor.x86_64 = "res://addons/gdai/bin/linux/libgdai.linux.editor.x86_64.so"
          
          # macOS
          macos.editor = "res://addons/gdai/bin/macos/libgdai.macos.editor.universal.dylib"
          EOF
          
          echo "Generated gdextension file:"
          cat release/addons/gdai/gdai.gdextension
      
      - name: Copy plugin files
        run: |
          # Copy core plugin files
          cp plugin/plugin.cfg release/addons/gdai/
          cp plugin/plugin.gd release/addons/gdai/
          
          # Copy plugin directory if it exists
          if [ -d "plugin/plugin" ]; then
            cp -r plugin/plugin release/addons/gdai/
            echo "✅ Plugin UI scripts copied"
          fi
          
          echo "Plugin structure:"
          ls -laR release/addons/gdai/
      
      - name: Create README for plugin
        run: |
          cat > release/addons/gdai/README.md << 'EOF'
          # GodotAI - AI-Powered Editor Plugin
          
          AI-powered project management for Godot via Claude Desktop and MCP.
          
          ## Installation
          
          1. Copy the `gdai` folder to your Godot project's `addons/` directory
          2. Restart Godot or reload the project  
          3. Enable the plugin in Project → Project Settings → Plugins
          
          ## Requirements
          
          - Godot 4.4 or higher
          - One of the supported platforms:
            - Windows x86_64
            - Linux x86_64  
            - macOS Universal (x86_64 + ARM64)
          
          ## Documentation
          
          For full documentation, visit: https://github.com/RectangleEquals/godotai
          
          ## License
          
          MIT License - See LICENSE file for details
          EOF
      
      - name: Copy LICENSE
        run: |
          if [ -f "LICENSE" ]; then
            cp LICENSE release/addons/gdai/
          fi
      
      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="dev-${GITHUB_SHA::7}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
      
      - name: Create archive
        run: |
          cd release
          zip -r ../godotai-${{ steps.version.outputs.version }}.zip addons/
          cd ..
          
          # Create checksums
          sha256sum godotai-${{ steps.version.outputs.version }}.zip > checksums.txt
          
          echo "Archive created:"
          ls -lh godotai-${{ steps.version.outputs.version }}.zip
      
      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: godotai-package-${{ steps.version.outputs.version }}
          path: |
            godotai-${{ steps.version.outputs.version }}.zip
            checksums.txt
          retention-days: 30
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            godotai-${{ steps.version.outputs.version }}.zip
            checksums.txt
          body: |
            ## GodotAI ${{ steps.version.outputs.version }}
            
            ### Installation
            
            1. Download `godotai-${{ steps.version.outputs.version }}.zip`
            2. Extract the `addons/gdai/` folder to your Godot project's `addons/` directory
            3. Restart Godot or reload the project
            4. Enable the plugin in Project → Project Settings → Plugins
            
            ### Supported Platforms
            
            - ✅ Windows x86_64
            - ✅ Linux x86_64
            - ✅ macOS Universal (Intel + Apple Silicon)
            
            ### What's New
            
            See the commit history for detailed changes.
            
            ### Checksums
            
            See `checksums.txt` for SHA256 verification.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}